---
title: "Forecasting Tetouan Power Consumption"
author: "Uyen Pham"
date: "2022-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The data has 52,416 energy consumption observations in 10-minute windows starting from January 1st, 2017, all the way through December 30th (not 31st) of the same year. Some of the features are:

1. Date Time: Time window of ten minutes.
2. Temperature: Weather Temperature in Â°C
3. Humidity: Weather Humidity in %
4. Wind Speed: Wind Speed in km/h
4. General Diffusion Flow
5. Diffusion Flow
6. Zone 1 Power Consumption in KiloWatts (KW)
7. Zone 2 Power Consumption in KW
8. Zone 3 Power Consumption in KW

```{r}
library(tidyverse)
library(fpp2)
library(readr)
library(forecast)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(dplyr)
library(lubridate)
set.seed(506)
```


```{r}
#Load the data 
power <- read_csv("Tetuan City power consumption.csv", 
    col_types = cols(DateTime = col_datetime(format = "%m/%d/%Y %H:%M")))

#Rename the columns
colnames(power) <- c('DateTime', 'Temperature', 'Humidity','Wind_Speed', 'Gen_Diffuse_Flows', 'Diffuse_Flows', 'Zone1', 'Zone2', 'Zone3')
head(power)
```

```{r}
summary(power)
```


```{r}
tail(power)
```

## Explainatory Data Analysis

```{r}
#Check for missing values in each column 
colSums(is.na(power))
```


--> No missing values


```{r}
# Plot power consumption Zone 1 (every 10 minutes)
ggplot(power, aes(x = DateTime, y = Zone1)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Power Consumption",
       x = "Date",
       y = "Power Consumption (kW)") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

```

```{r}
#Zone1.ts = ts(power$Zone1)
#Zone2.ts = ts(power$Zone2)
#Zone3.ts = ts(power$Zone2)

#Observe distribution of the 3 zones
plot(power$DateTime, power$Zone1, type = "l", col = 4,
     xlab = "Date",
     ylab = "Power Consumption (kW)")
lines(power$DateTime, power$Zone2, type = "l", col = 3)
lines(power$DateTime, power$Zone3, type = "l", col = 2)
legend("topright", c("Zone1", "Zone2", "Zone3"), lty = 1, col = 2:4)
```


```{r}
#Observe distribution of other variables
p1 <- ggplot(power, aes(x = DateTime, y = Temperature)) +
  geom_line(size = 0.5, color = "red") +
  labs(title = "Temperature") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p2 <- ggplot(power, aes(x = DateTime, y = Humidity)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Humidity") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p3 <- ggplot(power, aes(x = DateTime, y = Wind_Speed)) +
  geom_line(size = 0.5, color = "cyan") +
  labs(title = "Wind_Speed") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p4 <- ggplot(power, aes(x = DateTime, y = Gen_Diffuse_Flows)) +
  geom_line(size = 0.5, color = "black") +
  labs(title = "Gen_ Diffuse_Flows") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p5 <- ggplot(power, aes(x = DateTime, y = Diffuse_Flows)) +
  geom_line(size = 0.5, color = "black") +
  labs(title = "Diffuse_Flows") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

grid.arrange(p1, p2, p3, p4, p5, ncol = 2)
```

```{r}
#Observe the the pair plots between variables
plot(power[, 2:9],  pch = 16, cex= 0.3)
```

```{r}
#Correlation heatmap
corr <- round(x = cor(power[, 2:9]), digits = 2)
melted_corr <- melt(corr)

ggplot(data = melted_corr, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "#006666", high = "#FF6633", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 8, hjust = 1))+
  coord_fixed() +
  geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) 
  
```

--> Temperature seems to show highest correlation with power consumption


### Explore power consumption at different time ranges

```{r hourly}
#Hourly Power consumption
power_hourly <- power %>%
 group_by(Hour= format(DateTime, "%Y-%m-%d %H")) %>%
 summarise(Total= sum(Zone1))

#Convert Zone1_Consumption to time series
hour.zone1.ts <- ts(power_hourly$Total, start= c(2017,1), end=c(2017, 8376), frequency=8376)
#Plot the ts
autoplot(hour.zone1.ts, col = 4)
```


```{r Daily}
power$Date <- as.Date(power$DateTime, format = "%m/%d/%Y")
power.daily.z1 <- power %>% group_by(Date) %>% summarise(Total= sum(Zone1))
power.daily.z2 <- power %>% group_by(Date) %>% summarise(Total= sum(Zone2))
power.daily.z3 <- power %>% group_by(Date) %>% summarise(Total= sum(Zone3))

p1<- ggplot(power.daily.z1, aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Daily Power Consumption in Zone 1",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p2 <- ggplot(power.daily.z2, aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Daily Power Consumption in Zone 2",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

p3 <- ggplot(power.daily.z3, aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Daily Power Consumption in Zone 3",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))
grid.arrange(p1, p2, p3, ncol = 2)
```

## --> The deep drops in zone 1 and 2 could be due to holidays


```{r Weekly}
#Weekly Power consumption
power_weekly <- power %>%
 group_by(week = lubridate::week(Date)) %>% summarise(Total= sum(Zone1_Consumption))

ggplot(power_weekly, aes(x = week, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Week Power Consumption",
       x = "Weekly",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))

```


```{r Monthly}
power_monthly <- power %>%
  group_by(Month = format(Date, "%Y-%m")) %>%
  summarise(Total = sum(Zone1_Consumption))

ggplot(power_monthly, aes(x = Month, y = Total, group = 1)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Monthly Power Consumption",
       x = "Monthly",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))
```

### Explore the power consumption on the 10 minute data

```{r 10min}
#Convert Zone1_Consumption to time series
zone1.min.ts <- ts(power$Zone1)
#Plot the ts
autoplot(zone1.min.ts, col = 4)
```


```{r}
par(mar=c(5,5,5,2))
acf_value <- acf(power.daily.z1.ts)
#acf_value <- acf(zone1.min.ts)
```

--> Autocorrelation show strong correlation at multiple lag showing weekly seasonality


```{r zoom in zone 1}
ggplot(power.daily.z1[0:21, ], aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Power Consumption",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))
  #coord_cartesian(xlim = c(1, 14))
```



```{r zoom in zone 2}
ggplot(power.daily.z2[0:21, ], aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Power Consumption",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))
  #coord_cartesian(xlim = c(1, 14))
```

```{r zoom in zone 3}
ggplot(power.daily.z3[0:21, ], aes(x = Date, y = Total)) +
  geom_line(size = 0.5, color = "blue") +
  labs(title = "Power Consumption",
       x = "Daily",
       y = "Power Consumption") +
  theme_classic()+
  theme(plot.title=element_text(hjust=0.5))
  #coord_cartesian(xlim = c(1, 14))
```


--> The zoom in plot show the first few week where the consumption for zone 1 and 2 start with low sunday, high during the weekday and low on Saturday, and for zone 3 seem to be the opposite an dthe different between days less pronounce. Maybe zone1 and 2 are industrial and zone 3 is households.


```{r}
power.daily.z1.ts1 <-ts(power.daily.z1$Total) 
autoplot(power.daily.z1.ts1)+
  scale_x_continuous(breaks = seq(1,364,by=28)) #x-axis tick by 4 weeks
 #coord_cartesian(xlim = c(2017.0, 2017.10)) # 1 week ~ 0.02
```


*************************************

**MODELS**

*************************************


## Using Daily data for the following 

```{r}
#Convert power data frame to daily data 
daily <- power[ ,2:10] %>%
   group_by(Date) %>%
   summarise(across(everything(), sum), .groups = 'drop')
```


```{r}
head(daily)
```


## Create new variables and dataframes

```{r Create new variables and dataframes}
#Create day of the week column
daily$DOW <- wday(daily$Date, label = TRUE)
#Create month column 
daily$Month <- month(daily$Date, label = TRUE)
#Do we need working and non-working columns? why weekday seem to consume more energy than weekend? Are the zones belong to industrial zones?
#create new frames with values in Month, DOW converted to dummies
Month.dummies <- model.matrix(~ 0 + Month, data = daily)
DOW.dummies <- model.matrix(~ 0 + DOW, data = daily)
#Rename each dummies column without "Month", "Dow" in front 
colnames(Month.dummies) <- gsub("Month", "", colnames(Month.dummies)) #Replace "Month" with none-character
colnames(DOW.dummies) <- gsub("DOW", "", colnames(DOW.dummies))
#Combine the data frames
X <- as.data.frame(cbind(daily[,2:6], Month.dummies[, -12], DOW.dummies[, -7]))
#Create y series with power values from daily data frame
y1 <- daily$Zone1
#Split data
nTotal1 <- length(y1)
nValid1 <- 60
nTrain1 <- nTotal1 - nValid1
xTrain1 <- X[1:nTrain1, ]
yTrain1 <- y1[1:nTrain1]
xValid1 <- X[(nTrain1 + 1):nTotal1, ]
yValid1 <- y1[(nTrain1 + 1):nTotal1]
#Convert y train into time series object
yTrain1.ts <- ts(yTrain1, start = c(2017, 1), end= c(2017, 304),                             frequency = 365)
yValid1.ts <- ts(yTrain1, start = c(2017, 305), end= c(2017, 364),                             frequency = 365)
```

## Build Models

### TLSM 

```{r TSLM model}
#Create the formula for the regression model
(formula <- as.formula(paste("yTrain1.ts", paste(c("trend", colnames(xTrain1)), collapse = "+"), sep = "~")))
#Train the regression model
zone1.tslm <- tslm(formula, data = xTrain1, lambda = 1) #lamda=1 for linear trend
#Predict valid set
zone1.tslm.pred <- forecast(zone1.tslm, newdata = xValid1)
#Plot the prediction
plot(zone1.tslm.pred, ylim = c(0, 8000), xlab = "Days", ylab = "Zone 1 Power Consumption")
```

### TLSM on power consumption ts only

```{r TSLM model}
lm = tslm(yTrain1.ts ~ trend + season)
summary(lm)
```

```{r}
yTrain1.ts
```

```{r}
#Apply Holt-Winterâs exponential smoothing (with additive error,
##additive trend and multiplicative seasonality)
est.model <- ets(yTrain1.ts, model = "ZMA", alpha = .2, gamma = .05, 
                       restrict = FALSE)
summary(est.model)
```


```{r}
#Forecast test set
test.predict <- forecast(est.model, 60)
test.predict
#Print out model performance on test set
accuracy(test.predict, yValid1.ts)
```


```{r}
#plot the forecast
autoplot(yTrain1.ts) + 
  autolayer(test.predict, color = "red") +
  autolayer(yValid1.ts, color = "gray") +
  labs(title = "Zone 1 Power Consumption Forecast",
       x = "Date",
       y = "Power Consumption (kW)")+
  theme(plot.title=element_text(hjust=0.5)) 
  #+coord_cartesian(xlim = c(, ))
```


```{r Arima model}
#Convert df to matrix
predictor_train <- as.matrix(xTrain1[,1:2])
#Run Arima model
zone1.arima.model <- Arima(yTrain1, order = c(1,0,0), xreg = predictor_train)
summary(zone1.arima.model)
#Forecast sale on the test set
test_predictors <- as.matrix(store.test[, 2:6])
arima_predict <- forecast(arima_reg_model, h = 26, xreg =predictor_test)
arima_predict.ts <- ts(arima_predict$mean, start = c(2012, 44), end= c(2013, 17),                             frequency = 52)
#Plot the forecast sales
autoplot(outcome.ts)+
  autolayer(arima_predict.ts )+
  labs(title = "Forecasting Weekly Sale Using Arima model",
       x = "Year",
       y = "Sale")+
  theme(plot.title=element_text(hjust=0.5))
```

```{r}
#Forecast sale on the test set
test_predictors <- as.matrix(xValid1[,1:2])
arima_predict <- forecast(zone1.arima.model,h=60, xreg =test_predictors)


arima_predict.ts <- ts(arima_predict$mean, start = c(2017, 305), end= c(2017, 364),                             frequency = 365)
# #Plot the forecast sales
# autoplot(yTrain1.ts)+
#   autolayer(arima_predict.ts )+
#   labs(title = "Forecasting Weekly Sale Using Arima model",
#        x = "Year",
#        y = "Sale")+
#   theme(plot.title=element_text(hjust=0.5))
```


```{r}
#Plot the forcast
autoplot(yTrain1.ts) + 
  autolayer(yValid1.ts, color = "gray")+
  autolayer(arima_predict.ts, color = "red")+
  labs(title = "Zone 1 Power Consumption Forecast",
       x = "Date",
       y = "Power Consumption (kW)")+
  theme(plot.title=element_text(hjust=0.5))
  #coord_cartesian(xlim = c(1990, 1995))+
  #legend("topright", c("Train", "Test", "Forecast"), lty = 1, col = 2:4)
```

```{r}
# plot(arima_predict, ylab="Power Consumption (kW)", main="Zone 1 Power Consumption Forecast", xlab="Date")
# # Plot Fitted values
# lines(zone1.arima.model$fitted.values, col="red")  
# lines(yValid1.ts, col="black")
# legend("topleft", c("Actual", "Fitted value", "Forecast"), 
#        col = c("black", "red", "4"), lty = 1) 
```


```{r}
accuracy(test.predict, yValid1.ts)
accuracy(arima_predict.ts, yValid1.ts)
```

```{r}

```



### Still working on 

```{r}
stl.run <- stl(power.daily.z1.ts, s.window = "periodic")
plot(stl.run)
```


```{r}
stl.run <- stl(power.daily.z1.ts, s.window = "periodic")
plot(stl.run)
```


```{r}
#Plot boxplots to observe outliers
par(mfrow = c(2, 2))
boxplot(power$Humidity, main="Humidity")
boxplot(power$General_Diffuse_Flows , main="General Diffuse Flows")
boxplot(power$Temperature, main="Temperature")
boxplot(power$Wind_Speed, main="Wind_Speed")
```


```{r}
autoplot(power[c("Temperature", "Humidity", "Wind_Speed", "Gen_Diffuse_Flows", "Diffuse_Flows")], facets=TRUE) +
  xlab("Year: 2017") + ylab("") +
  ggtitle("10 Minute External Factors")
```


```{r}
autoplot(power[,1:6], facets=TRUE) +
  ylab("Number of visitor nights each quarter (millions)")
```


```{r}
```



